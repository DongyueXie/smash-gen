---
title: "Shrink R squared - example"
author: "Dongyue Xie"
date: "2019-01-21"
output: 
  workflowr::wflow_html:
    code_folding: hide
---

For the method used in these examples, see [here](r2.html)

True $R^2$ is defined as $R^2=\frac{var(X\beta)}{var(y)}=\frac{var(y)-\sigma^2}{var(y)}=1-\frac{\sigma^2}{var(y)}=1-\frac{\sigma^2}{\sigma^2+var(X\beta)}$

Ajusted R^2: $1-\frac{\sum(y_i-\hat y_i)^2/(n-p-1)}{\sum(y_i-\bar y)^2/(n-1)}$

Shrink adjusted R^2: use fash shrinking $fash.output=\log(\frac{\sum(y_i-\hat y_i)^2/(n-p-1)}{\sum(y_i-\bar y)^2/(n-1)})$ then shrunk adjusted R^2 is $1-\exp(fash.output)$

Shrink R^2 = $1 - \exp(fash.output)*\frac{n-p-1}{n-1}$, because $R^2=1-\frac{\sum(y_i-\hat y_i)^2}{\sum(y_i-\bar y)^2}=1-\frac{\sum(y_i-\hat y_i)^2/(n-p-1)}{\sum(y_i-\bar y)^2/(n-1)}*\frac{n-p-1}{n-1}=1-(1-adjR^2)*\frac{n-p-1}{n-1}$

## R Function

R function for shrinking adjusted R/ R squared:

```{r}
library(ashr)
#'@param R2: R squared from linear regression model fit
#'@param n: sample size
#'@param p: number od covariates
#'@output shrinked R squared.
ash_r2=function(R2,n,p){
  df1=n-p-1
  df2=n-1
  log.ratio=log((1-R2)/(df1)*(df2))
  shrink.log.ratio=ash(log.ratio,1,lik=lik_logF(df1=df1,df2=df2))$result$PosteriorMean
  shrinked.ar2=1-exp(shrink.log.ratio)
  shrinked.r2=1-exp(shrink.log.ratio)*df1/df2
  return(list(shrinked.r2=shrinked.r2,shrinked.ar2=shrinked.ar2))
}

```

## Compare Shrinked $R^2$ with True $R2$.

Assume linear model $y=X\beta+\epsilon$ where $\epsilon\sim N(0,\sigma^2I)$

1. n=100, p=5. $\beta$ ranges from 0 to 1, for example $\beta=(0,0,0,0,0)$,...,$\beta=(0.1,0.1,0.1,0.1,0.1)$,..., $\beta=(1,1,1,1,1)$ etc.  $y=X\beta+\epsilon$ where $\epsilon\sim N(0,I_n)$.

```{r}
set.seed(1234)

n=100
p=5
R2=c()
R2a=c()
trueR2=c()

beta.list=seq(0,1,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  
  beta=rep(beta.list[i],p)
  y=X%*%beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2s=ash_r2(R2,n,p)$shrinked.r2
R2as=ash_r2(R2,n,p)$shrinked.ar2
plot(beta.list,R2,ylim=range(c(R2,R2a,R2s,R2as,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2a,col=2)
lines(beta.list,R2as,col=3)
lines(beta.list,R2s,col=4)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R^2','Adjusted R^2','Adjusted R^2 fash','R^2 fash','True R^2'),lty=c(1,1,1,1,1),col=c(1,2,3,4,'grey80'))

plot(trueR2,R2,type='l',ylim=range(c(R2,R2a,R2s,R2as,trueR2)))
lines(trueR2,R2a,col=2)
lines(trueR2,R2as,col=3)
lines(trueR2,R2s,col=4)
lines(trueR2,trueR2,col='grey80')
legend('topleft',c('R^2','Adjusted R^2','Adjusted R^2 fash','R^2 fash'),lty=c(1,1,1,1),col=c(1,2,3,4))

```


2. n=20, p=3. 

```{r}
set.seed(1234)

n=20
p=3
R2=c()
R2a=c()
trueR2=c()

beta.list=seq(0,1,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  beta=rep(beta.list[i],p)
  y=X%*%beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2s=ash_r2(R2,n,p)$shrinked.r2
R2as=ash_r2(R2,n,p)$shrinked.ar2
plot(beta.list,R2,ylim=range(c(R2,R2a,R2s,R2as,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2a,col=2)
lines(beta.list,R2as,col=3)
lines(beta.list,R2s,col=4)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R^2','Adjusted R^2','Adjusted R^2 fash','R^2 fash','True R^2'),lty=c(1,1,1,1,1),col=c(1,2,3,4,'grey80'))

plot(trueR2,R2,type='l',ylim=range(c(R2,R2a,R2s,R2as,trueR2)))
lines(trueR2,R2a,col=2)
lines(trueR2,R2as,col=3)
lines(trueR2,R2s,col=4)
lines(trueR2,trueR2,col='grey80')
legend('topleft',c('R^2','Adjusted R^2','Adjusted R^2 fash','R^2 fash'),lty=c(1,1,1,1),col=c(1,2,3,4))
```

**When n is small, all $R^2$ are shrunk to zero. Try to increase beta: from 0-1 to 0-2** 

```{r}
set.seed(1234)

n=20
p=3
R2=c()
R2a=c()
trueR2=c()

beta.list=seq(0,2,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  beta=rep(beta.list[i],p)
  y=X%*%beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2s=ash_r2(R2,n,p)$shrinked.r2
R2as=ash_r2(R2,n,p)$shrinked.ar2
plot(beta.list,R2,ylim=range(c(R2,R2a,R2s,R2as,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2a,col=2)
lines(beta.list,R2as,col=3)
lines(beta.list,R2s,col=4)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R^2','Adjusted R^2','Adjusted R^2 fash','R^2 fash','True R^2'),lty=c(1,1,1,1,1),col=c(1,2,3,4,'grey80'))

plot(trueR2,R2,type='l',ylim=range(c(R2,R2a,R2s,R2as,trueR2)))
lines(trueR2,R2a,col=2)
lines(trueR2,R2as,col=3)
lines(trueR2,R2s,col=4)
lines(trueR2,trueR2,col='grey80')
legend('topleft',c('R^2','Adjusted R^2','Adjusted R^2 fash','R^2 fash'),lty=c(1,1,1,1),col=c(1,2,3,4))
```

## Compare fash and corshrink

### 1-d case

n=100,p=1

```{r}
library(CorShrink)
set.seed(1234)

n=100
p=1
R2=c()
#R2a=c()
trueR2=c()

beta.list=seq(0,1,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  beta=rep(beta.list[i],p)
  y=X*beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2.fash=ash_r2(R2,n,p)$shrinked.r2
R2.cor=(CorShrinkVector(sqrt(R2),n))^2
plot(beta.list,R2,ylim=range(c(R2.fash,R2.cor,R2,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2.cor,col=2)
lines(beta.list,R2.fash,col=4)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R2','R^2 fash','R^2 CorShrink','True R^2'),lty=c(1,1,1,1),col=c(1,4,2,'grey80'))

plot(trueR2,R2.fash,type='l',ylim=range(c(R2.fash,R2.cor,trueR2)),ylab='')
lines(trueR2,R2.cor,col=2)
lines(trueR2,trueR2,col='grey80')
legend('topleft',c('R^2 fash','R^2 CorShrink'),lty=c(1,1),col=c(1,2))
```

n=20,p=1

```{r}
set.seed(1234)

n=20
p=1
R2=c()
#R2a=c()
trueR2=c()

beta.list=seq(0,1,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  beta=rep(beta.list[i],p)
  y=X*beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2.fash=ash_r2(R2,n,p)$shrinked.r2
R2.cor=(CorShrinkVector(sqrt(R2),n))^2
plot(beta.list,R2.fash,ylim=range(c(R2.fash,R2.cor,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2.cor,col=2)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R^2 fash','R^2 CorShrink','True R^2'),lty=c(1,1,1),col=c(1,2,'grey80'))

plot(trueR2,R2.fash,type='l',ylim=range(c(R2.fash,R2.cor,trueR2)),ylab='')
lines(trueR2,R2.cor,col=2)
lines(trueR2,trueR2,col='grey80')
legend('topleft',c('R^2 fash','R^2 CorShrink'),lty=c(1,1),col=c(1,2))
```


### Multiple 

n=100, p=5

```{r}
library(CorShrink)
set.seed(1234)

n=100
p=5
R2=c()
#R2a=c()
trueR2=c()

beta.list=seq(0,1,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  beta=rep(beta.list[i],p)
  y=X%*%beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2.fash=ash_r2(R2,n,p)$shrinked.r2
R2.cor=(CorShrinkVector(sqrt(R2),n))^2
plot(beta.list,R2.fash,ylim=range(c(R2.fash,R2.cor,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2.cor,col=2)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R^2 fash','R^2 CorShrink','True R^2'),lty=c(1,1,1),col=c(1,2,'grey80'))

plot(trueR2,R2.fash,type='l',ylim=range(c(R2.fash,R2.cor,trueR2)),ylab='')
lines(trueR2,R2.cor,col=2)
lines(trueR2,trueR2,col='grey80')
legend('bottomright',c('R^2 fash','R^2 CorShrink'),lty=c(1,1),col=c(1,2))

```

n=20, p=3

```{r}

set.seed(1234)

n=20
p=3
R2=c()
#R2a=c()
trueR2=c()

beta.list=seq(0,1,length.out = 100)
X=matrix(runif(n*(p),0,2),n,p)
for (i in 1:length(beta.list)) {
  beta=rep(beta.list[i],p)
  y=X%*%beta+rnorm(n)
  datax=data.frame(X=X,y=y)
  mod=lm(y~X,datax)
  mod.sy=summary(mod)
  R2[i]=mod.sy$r.squared
  R2a[i]=mod.sy$adj.r.squared
  trueR2[i]=1-(1)/(1+var(X%*%beta))
}
R2.fash=ash_r2(R2,n,p)$shrinked.r2
R2.cor=(CorShrinkVector(sqrt(R2),n))^2
plot(beta.list,R2.fash,ylim=range(c(R2.fash,R2.cor,trueR2)),main='',xlab='beta',ylab='',type='l')
lines(beta.list,R2.cor,col=2)
lines(beta.list,trueR2,col='grey80')
abline(h=0,lty=2)
legend('topleft',c('R^2 fash','R^2 CorShrink','True R^2'),lty=c(1,1,1),col=c(1,2,'grey80'))

plot(trueR2,R2.fash,type='l',ylim=range(c(R2.fash,R2.cor,trueR2)),ylab='')
lines(trueR2,R2.cor,col=2)
lines(trueR2,trueR2,col='grey80')
legend('bottomright',c('R^2 fash','R^2 CorShrink'),lty=c(1,1),col=c(1,2))

```




